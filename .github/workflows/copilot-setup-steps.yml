name: Copilot setup steps

on:
  workflow_call:
    secrets: inherit
    inputs:
      base_branch:
        description: Branch to base the Copilot agent work on
        required: false
        default: main
        type: string
      pr_base:
        description: Target branch for the Copilot-created pull request
        required: false
        default: main
        type: string
    outputs:
      branch_name:
        description: Branch where the Copilot agent should push changes
        value: ${{ jobs.prepare-agent-branch.outputs.branch_name }}
      base_branch:
        description: Branch to use as the base checkout for the agent
        value: ${{ jobs.prepare-agent-branch.outputs.base_branch }}
      pr_base:
        description: Target branch for the Copilot-created pull request
        value: ${{ jobs.prepare-agent-branch.outputs.pr_base }}

permissions:
  contents: write
  pull-requests: write

jobs:
  prepare-agent-branch:
    runs-on: ubuntu-latest
    outputs:
      branch_name: ${{ steps.branch.outputs.branch_name }}
      base_branch: ${{ steps.branch.outputs.base_branch }}
      pr_base: ${{ steps.branch.outputs.pr_base }}
    steps:
      - name: Configure isolated branch for Copilot agent
        id: branch
        run: |
          BRANCH_NAME="copilot/${GITHUB_RUN_ID}"
          echo "branch_name=${BRANCH_NAME}" >> "$GITHUB_OUTPUT"
          echo "base_branch=${{ inputs.base_branch }}" >> "$GITHUB_OUTPUT"
          echo "pr_base=${{ inputs.pr_base }}" >> "$GITHUB_OUTPUT"
          echo "::notice::Configured Copilot agent to use branch ${BRANCH_NAME} instead of pushing to protected main."
      - name: Surface branch outputs for caller
        run: |
          {
            echo "branch_name: ${{ steps.branch.outputs.branch_name }}"
            echo "base_branch: ${{ steps.branch.outputs.base_branch }}"
            echo "pr_base: ${{ steps.branch.outputs.pr_base }}"
            echo ""
            echo "Set COPILOT_AGENT_BRANCH_NAME, COPILOT_AGENT_BASE_BRANCH, and COPILOT_AGENT_PR_BASE from these outputs in the calling workflow to avoid pushing to protected branches."
            echo "Branches follow the copilot/<run_id> pattern and should be cleaned up after their PRs merge."
          } >> "$GITHUB_STEP_SUMMARY"
